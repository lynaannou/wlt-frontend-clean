<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>WLT USTHB: Statistiques</title>
  <link rel="stylesheet" href="Styles/Statistiques.css" />
  <link rel="icon" href="Assets/Logo,_USTHB.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  
  <div class="container">
    <h1>ğŸ“Š Statistiques GÃ©nÃ©rales</h1>

   

    <div class="prof-list">
      <h2>ğŸ‘¤ Liste des Professeurs</h2>
      <div id="professorButtons" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 40px;"></div>
    </div>

    <div class="stats-box" id="statsSection">
      <p>Total de professeurs inscrits: <span id="profCount">--</span></p>
      
    </div>

    <div class="chart-area" id="printArea">
      <canvas id="barChart" width="400" height="250"></canvas>
    </div>

    <div class="buttons-area" style="margin-top: 40px;">
  <button onclick="downloadBackendExcel(1)">ğŸ“¥ Excel S1</button>
  <button onclick="downloadBackendExcel(2)">ğŸ“¥ Excel S2</button>
  <button onclick="downloadPDF(1)">ğŸ§¾ PDF S1</button>
  <button onclick="downloadPDF(2)">ğŸ§¾ PDF S2</button>
  <button onclick="window.print()">ğŸ–¨ï¸ Imprimer</button>
</div>
  </div>

  <script>
    const email = localStorage.getItem("email");
    const isChef = localStorage.getItem("isChef");

    if (isChef !== "true") {
      alert("AccÃ¨s rÃ©servÃ© aux chefs de dÃ©partement.");
      window.location.href = "index.html";
    }

    const storedDepartementId = localStorage.getItem("departementId");

    if (!storedDepartementId) {
      fetch(`https://wlt-usthb-backend.onrender.com/api/professeurs/by-email?email=${encodeURIComponent(email)}`, {
  credentials: "include" // âœ… Added
}) 
      .then(res => res.json())
        .then(professeur => {
  if (professeur?.departement) {
    localStorage.setItem("departementId", professeur.departement);
    localStorage.setItem("professeurId", professeur.id); // âœ… ADD THIS LINE
    startStats(professeur.departement);
  } else {
    alert("Impossible de rÃ©cupÃ©rer le dÃ©partement du professeur.");
  }
})
;
    } else {
      startStats(storedDepartementId);
    }

    async function startStats(departementId) {
 const response = await fetch(`https://wlt-usthb-backend.onrender.com/api/form/inscrits/${departementId}`, {
  credentials: "include" // âœ… Added
});
  const rawProfessors = await response.json();

  // Fetch full voeux per prof
  const enrichedProfessors = await Promise.all(rawProfessors.map(async (prof) => {
    try {
      const res = await fetch(`https://wlt-usthb-backend.onrender.com/api/form/get?professeurId=${prof.id}`, {
  credentials: "include" // âœ… Added
});
  const data = await res.json();

      console.log(`ğŸ“¦ DonnÃ©es rÃ©cupÃ©rÃ©es pour ${prof.name} :`, data);

      const enriched = {
        ...prof,
        semestre1: data.semestre1 || [],
        semestre2: data.semestre2 || [],
        questions: {
          wantsExtraCourses: data.wantsExtraCourses ?? false,
          extraHoursS1: data.extraHoursS1 ?? 0,
          extraHoursS2: data.extraHoursS2 ?? 0,
          proposedLicence: data.proposedLicence ?? 0,
          proposedMaster: data.proposedMaster ?? 0
        }
      };

      console.log("âœ… Prof enrichi :", enriched);
      return enriched;

    } catch (e) {
      console.warn(`âŒ Erreur lors de la rÃ©cupÃ©ration des voeux pour ${prof.name}`, e);
      return { ...prof };
    }
  }));

  console.log("ğŸ“Š Professeurs enrichis finaux :", enrichedProfessors);
  localStorage.setItem("professors", JSON.stringify(enrichedProfessors));
  updateStatsAndUI(enrichedProfessors);
}
function downloadBackendExcel(semestre) {
  const profId = localStorage.getItem("professeurId"); // Tu dois tâ€™assurer que câ€™est bien stockÃ©

  if (!profId) {
    alert("Identifiant du chef de dÃ©partement introuvable.");
    return;
  }

  const url = `https://wlt-usthb-backend.onrender.com/api/admin/export/s${semestre}?profId=${profId}`;

  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error("Erreur lors de la gÃ©nÃ©ration du fichier.");
      return response.blob();
    })
    .then(blob => {
      const link = document.createElement("a");
      link.href = window.URL.createObjectURL(blob);
      link.download = `voeux_semestre${semestre}.xlsx`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    })
    .catch(err => {
      console.error("âŒ TÃ©lÃ©chargement Ã©chouÃ© :", err);
      alert("Erreur pendant le tÃ©lÃ©chargement du fichier Excel.");
    });
}
    function updateStatsAndUI(professors) {
      console.log("ğŸ” Mise Ã  jour de l'interface avec :", professors);
      localStorage.setItem("professors", JSON.stringify(professors));

      const stats = {
        profCount: professors.length,
        
      };

      document.getElementById("profCount").textContent = stats.profCount;
      

      renderFilteredList(professors);
      createParticipationGraph();
    }

    function renderFilteredList(professors) {
      const container = document.getElementById("professorButtons");
      container.innerHTML = "";
      professors.forEach(p => {
        const btn = document.createElement("button");
        btn.textContent = p.name;
        btn.className = "login_button";
        btn.onclick = () => {
          window.location.href = `professor.html?id=${p.id}`;
        };
        container.appendChild(btn);
      });
    }

    function createParticipationGraph() {
  const allProfs = JSON.parse(localStorage.getItem("allProfessors") || "[]");
  const departementId = parseInt(localStorage.getItem("departementId"));


  console.log("ğŸ“¦ allProfs:", allProfs);
  console.log("ğŸ·ï¸ storedDepartementId:", storedDepartementId, typeof storedDepartementId);

  const profsInDept = allProfs.filter(p => p.departementId === departementId);

  console.log("ğŸ“Š Profs du dÃ©partement :", profsInDept.length);

  const profsInscrits = JSON.parse(localStorage.getItem("professors") || "[]");
  const inscrits = profsInscrits.length;
  const total = profsInDept.length;
  const nonInscrits = total - inscrits;

  const ctx = document.getElementById("barChart").getContext("2d");
  new Chart(ctx, {
  type: "bar",
  data: {
    labels: ["Total Profs", "Inscrits", "Non inscrits"],
    datasets: [{
      label: "Statistiques",
      backgroundColor: ["#DE3163", "#FF69B4", "#FFB6C1"],
      data: [total, inscrits, nonInscrits]
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      title: {
        display: true,
        text: "Statistiques d'inscription",
        color: '#FFFFFF' // âœ… Title color
      }
    },
    scales: {
      x: {
        ticks: {
          color: '#FFFFFF' // âœ… X-axis label color
        }
      },
      y: {
        ticks: {
          color: '#FFFFFF' // âœ… Y-axis label color
        }
      }
    }
  }
});
    }
    function prepareData(semestre) {
  const professors = JSON.parse(localStorage.getItem("professors") || "[]");
  const rows = [];

  professors.forEach(p => {
    const mods = semestre === 1 ? (p.semestre1 || []) : (p.semestre2 || []);
    if (!mods.length) return;

    mods.forEach((mod, i) => {
      rows.push({
        "Nom": p.name,
        "Email": p.email,
        "DÃ©partement": p.departement || "",
        "Grade": p.grade || "",
        "Choix / Module": `Choix ${i + 1} / ${mod.name}`,
        "Cours": mod.cours ? "Oui" : "Non",
        "TD": mod.td ? "Oui" : "Non",
        "TP": mod.tp ? "Oui" : "Non",
        "Heures Suppl.": i === 0 ? (p.questions?.[`Heures supplÃ©mentaires S${semestre}`] || "") : "",
        "PFE Licence": i === 0 ? (p.questions?.["PFE Licence"] || "") : "",
        "PFE Master": i === 0 ? (p.questions?.["PFE Master"] || "") : ""
      });
    });
  });

  return rows;
}


async function downloadPDF(semestre) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("landscape");
  pdf.setFontSize(16);
  pdf.text(`Statistiques des Professeurs - Semestre ${semestre}`, 14, 20);

  const professors = JSON.parse(localStorage.getItem("professors") || "[]");
  console.log("ğŸ“¦ Professeurs rÃ©cupÃ©rÃ©s depuis localStorage :", professors);

  const tableData = [];

  professors.forEach((p, idx) => {
    console.log(`ğŸ” Traitement du professeur ${idx + 1} : ${p.name} ${p.prenom}`);

    const voeux = (semestre === 1 ? p.semestre1 : p.semestre2) || [];
    console.log(`ğŸ§¾ VÅ“ux Semestre ${semestre} :`, voeux);

    const choixModules = [null, null, null];

    voeux.forEach(v => {
      const index = (v.numChoix || 1) - 1;
      if (index >= 0 && index < 3) {
        choixModules[index] = {
          nom: v.module?.nom || "",
          nature: (v.nature || []).join(", "),
          niveau: v.module?.pallier || "",
          specialite: v.module?.specialite || ""
        };
      }
    });

    console.log("ğŸ“š Modules structurÃ©s :", choixModules);

    const q = p.questions || {};
    console.log("ğŸ“‹ Questions/besoins :", q);

    const row = [
      p.name || "",
      p.prenom || "",
      p.email || "",
      p.numBureau != null ? p.numBureau : ""
    ];
    console.log("ğŸ“„ Info prof (identitÃ©) :", row.slice(0, 4));

    choixModules.forEach((c, i) => {
      const modData = [c?.nom || "", c?.nature || "", c?.niveau || "", c?.specialite || ""];
      console.log(`ğŸ“˜ Choix ${i + 1} :`, modData);
      row.push(...modData);
    });

    const hasExtra = q.wantsExtraCourses ? "Oui" : "Non";
    const heuresSupp = semestre === 1 ? q.extraHoursS1 ?? 0 : q.extraHoursS2 ?? 0;

    console.log("â±ï¸ Heures supp ?", hasExtra);
    console.log("â³ Nombre heures supp :", heuresSupp);
    console.log("ğŸ“ PFE Licence :", q.proposedLicence);
    console.log("ğŸ“ PFE Master :", q.proposedMaster);

    row.push(hasExtra);
    row.push(heuresSupp);
    row.push(q.proposedLicence ?? 0);
    row.push(q.proposedMaster ?? 0);

    console.log("âœ… Ligne finale pour autoTable :", row);
    tableData.push(row);
  });

  console.log("ğŸ“Š DonnÃ©es finales Ã  exporter :", tableData);

  pdf.autoTable({
    head: [[
      "Nom", "PrÃ©nom", "Email", "Bureau",
      "Module 1", "Type 1", "Pallier 1", "SpÃ©cialitÃ© 1",
      "Module 2", "Type 2", "Pallier 2", "SpÃ©cialitÃ© 2",
      "Module 3", "Type 3", "Pallier 3", "SpÃ©cialitÃ© 3",
      "Heures supp ?", "Nbr", "PFE Licence", "PFE Master"
    ]],
    body: tableData,
    startY: 30,
    styles: { fontSize: 9 },
    theme: "grid"
  });

  console.log("ğŸ“¥ TÃ©lÃ©chargement du PDF...");
  pdf.save(`voeux_semestre${semestre}.pdf`);
}

  </script>
</body>
</html>
